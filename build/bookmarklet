javascript:(()=>{const CAPTIONS_ON_SELECTOR="Turn on captions",CAPTIONS_OFF_SELECTOR="Turn off captions",SELECTOR="c-wiz [jsmodel] > div > [jscontroller]:nth-of-type(5)",SCRAPE_RATE=500;let YOU,CHAT_LOG={};const captionsOnBtn=e=>"Turn on captions"===e.textContent,captionsOffBtn=e=>"Turn off captions"===e.textContent,links=e=>e.src.includes("googleusercontent.com/"),googImgs=e=>[...e.querySelectorAll("img")].filter(links).length;let TEST;try{TEST=process.env.TEST}catch(e){}function buildTranscript(){try{forceEnableCaptions();const e=domHasCaptions();if(!e.length)return;createDownloadButton(),getYouUser(),[...e[0].querySelectorAll("div:scope > div")].forEach(buildHandleCaption()),console.log(JSON.stringify(orderByTime().slice(-5),null,2))}catch(e){console.log("ERR:",e)}setTimeout(buildTranscript,500)}function buildHandleCaption(e,t=!1){const n=(...e)=>t&&console.log(...e);return CHAT_LOG=e&&e.CHAT_LOG||CHAT_LOG,function(e,t){const o=(new Date).getTime(),i=(new Date).getTime(),r=e.querySelector("div").innerHTML,s="you"===r.toLowerCase()?YOU:r,l=getMessage(e),c={created:o,updated:i,user_id:s,message:l},a=orderByTime(!0),d=a[a.length-1],u=!d||d.user_id!==s,p=u?c:d,{message:f,created:g}=p||{},T=f&&f.toLowerCase(),m=l.toLowerCase(),O=findOverlap(T,m),C=f.slice(0,f.indexOf(O)),h=l.slice(O.length),y=!C&&!h&&O&&l||C+O+h,A=CHAT_LOG[s]&&CHAT_LOG[s].length,L=A&&CHAT_LOG[s][A-1],{message:H,created:_,updated:v}=L||{},E=0===t,w=!!u,S=m===T,b=""===l.trim(),x=S||b,G=!CHAT_LOG[c.user_id],R=G||x||!T,B=detectRewrites(T,m,O);if(n("oldCaptionData",p),n("isFirstCaptionOnScreen:",E),n("isFirstCaptionForUser:",G),n("isStaleOrEmpty:",x),n("isRewrite:",B),w||c!==p){if(E&&!G){if(!l.includes(H))return;return c.created=_,H===l&&(c.updated=v),void(CHAT_LOG[s][A-1]=c)}if(w||E||R){if(G&&(CHAT_LOG[s]=[]),w)return n("new speaker:",c.user_id),void CHAT_LOG[s].push(c);if(E)return n("adding message after fade"),void CHAT_LOG[s].push(c);if(!T)return n("appending. no overlap or no prior message",c),void CHAT_LOG[s].push(c)}return B?(n("rewrite!",y),c.message=y,c.created=g,void(CHAT_LOG[s][CHAT_LOG[s].length-1]=c)):void 0}}}function orderByTime(e){const t=[];for(var n in CHAT_LOG)t.push(CHAT_LOG[n]);const o=t.flat(),i=e?"created":"updated";return o.sort((e,t)=>e[i]-t[i])}function getMessage(e){const t=[];return[...e.querySelectorAll("span > span")].forEach(({innerHTML:e})=>t.push(e)),t.join(" ")}function findOverlap(e,t){return 0===t.length?"":e.endsWith(t)||e.indexOf(t)>=0?t:findOverlap(e,t.substring(0,t.length-1))}function detectHomonyms(e,t){const n=e=>e.replace(/[^0-9a-z]/gi,""),o=e.split(" ").map(n).filter(e=>e.length),i=t.split(" ").map(n).filter(e=>e.length),r=o.length<=i.length,s=o.length>i.length,l=r?o:i,c=s?o:i,a=c.filter(e=>l.includes(e)),d=Math.floor(.5*c.length);return a.length>=c.length-d}function detectPartialRewrite(e,t){const n=e.replace(/[^0-9a-z]/gi,"");return 0===t.split(".")[0].replace(/[^0-9a-z]/gi,"").indexOf(n)}function detectRewrites(e,t,n){const o=detectHomonyms(e,t),i=0===t.indexOf(e),r=detectPartialRewrite(e,t),s=n.length>1&&e.indexOf(n)>=0;return o||i||r||s}function domHasCaptions(){const e=[...document.querySelectorAll(SELECTOR)].filter(googImgs);return e.length?e:(console.log("no chat on screen presently"),setTimeout(buildTranscript,500),!1)}function forceEnableCaptions(){const e=[...document.querySelectorAll("div")];if(e.find(captionsOffBtn))return;const t=e.find(captionsOnBtn);t&&t.click()}function getYouUser(){const e=[...document.querySelectorAll("script")].find(e=>e.textContent.includes("AF_initDataCallback({key: 'ds:7")).innerText,t=e.slice(e.indexOf("["),e.indexOf("]")+1);YOU=JSON.parse(t)[6]}function createDownloadButton(){const e=document.getElementById("transcript");e&&e.remove();var t=document.createElement("div");t.id="transcript",t.style.zIndex="9",t.style.position="absolute",t.style.top="50%",t.style.left="0",t.style.width="100px",t.style.height="100px",t.style.background="teal",t.style.color="black",t.style.textAlign="center",t.innerHTML="click me to download transcript",t.onclick=()=>{var e=window.document.createElement("a");const t=orderByTime().map(e=>`"${e.created}","${e.updated}","${e.user_id}","${e.message}"`);e.href=window.URL.createObjectURL(new Blob([t.join("
")],{type:"text/csv"})),e.download="transcript.csv",document.body.appendChild(e),e.click(),document.body.removeChild(e)},document.body.appendChild(t)}"true"!==TEST&&buildTranscript(),TEST&&(module.exports={buildHandleCaption:buildHandleCaption});})()
